# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
# Gradle
# Build your Java project and run tests with Gradle using a Gradle wrapper script.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

variables:
  - group: cdn_git

trigger:
  - master

pr:
  - master

steps:
- checkout: self  # self represents the repo where the initial Pipelines YAML file was found
  clean: true  # whether to fetch clean each time
  fetchDepth: 1  # the depth of commits to ask Git to fetch
  lfs: true  # whether to download Git-LFS files
  submodules: recursive  # set to 'true' for a single level of submodules or 'recursive' to get submodules of submodules
- script: zip -T -r -9 MoeCraft-Resourcepack.zip ./*
  displayName: Compress MoeCraft Resourcepack  # friendly name displayed in the UI
  name: compress  # identifier for this step (A-Z, a-z, 0-9, and underscore)
- script: git clone --depth=1 https://$(cdn_git_user):$(cdn_git_token)@dev.azure.com/MoeCraft/$(resbuild_git_repo)/_git/$(resbuild_git_repo) ./MoeCraftCDN
  displayName: Checkout MoeCraft CDN Repo  # friendly name displayed in the UI
  name: checkoutgit  # identifier for this step (A-Z, a-z, 0-9, and underscore)
- script: cp -f ./MoeCraft-Resourcepack.zip ./MoeCraftCDN/MoeCraft-Resourcepack.zip
  displayName: Copy Resourcepack ZIP  # friendly name displayed in the UI
  name: preparefile  # identifier for this step (A-Z, a-z, 0-9, and underscore)
- script: |
    rm -rf .git
    cd MoeCraftCDN
    git config --global user.email "ci@moecraft.net"
    git config --global user.name "MoeCraft Auto CI"
  displayName: Configure git  # friendly name displayed in the UI
  name: configgit  # identifier for this step (A-Z, a-z, 0-9, and underscore)
- script: |
    cd MoeCraftCDN
    git add .
    git commit -m AutoCommit-ResourcePack-CI -v -a
    git push --force -v "origin" master
  displayName: Git Commit and Push  # friendly name displayed in the UI
  name: commit  # identifier for this step (A-Z, a-z, 0-9, and underscore)